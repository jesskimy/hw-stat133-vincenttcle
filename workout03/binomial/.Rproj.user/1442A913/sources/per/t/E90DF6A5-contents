#############
# RNAseq data R script
# 4/1/19
# input: CSV file "genes_tpm_samples.csv"
# output: 4 dataframes for each contrast, containing the p-values from a two way ANova/Tukey for each gene.
############


############
### PREPARATION
###########
## Loading packages that will be needed
library(dplyr)
library(RColorBrewer)
library(gplots)

setwd("~/Desktop/Gronert Lab/RNASeq_Project/Code/")
###########
#### DATA READING AND DATA PREP
###########
## reading data
rnadata <- read.csv("../Data/genes_tpm_samples.csv")
rnadata
head(rnadata)

## naming the gene column
names(rnadata)[1] <- "ext_gene"
head(rnadata)

## flipping rows and columns so genes are on the X and samples are on the Y
rnadata_flipped <- t(rnadata[-1])
head(rnadata_flipped)[, 1:5]

## reassigning column names to the gene names
colnames(rnadata_flipped) <- rnadata[,1]
head(rnadata_flipped)[, 1:5]

## turning rnadata_flipped into a dataframe so it can be easily manipulated
rnadf <- data.frame(rnadata_flipped)
head(rnadf)[,1:5]

## making a separate dataframe "characteristics" with sample characteristics
sample_name <- rownames(rnadf)
sex <- c(rep("F", 6), rep("M", 6))
cond <- c(rep("DED", 3), rep("Healthy", 3), rep("DED", 3), rep("Healthy", 3))
characteristics <- data.frame(sample_name, sex, cond)

## merging rnadf and characteristics together
rnadf_full <- cbind(characteristics, rnadf)
rnadf_full[,1:5]

## deleting the rownames because theyre now redundant
rownames(rnadf_full) <- NULL
rnadf_full[,1:5]

## rnadf_full is the dataframe that I will use for the rest of the analysis. I will export it now as a csv so it can be accessed later.
write.table(rnadf_full, file = "../results/rnadf_full.csv", sep = ",")



###########
### ANALYSIS
###########
## making empty lists for each of the four conditions
mdedvfded <- c()
fhvfded <- c()
mhvmded <- c()
mhvfh <- c()
dedvh <- c()



## for loop to fill all these lists
for(i in names(rnadf_full[,-(1:3)])){
  mod <- aov(get(i) ~ sex*cond, rnadf_full)
  a <- data.frame(TukeyHSD(mod)[3])[1,4]
  b <- data.frame(TukeyHSD(mod)[3])[2,4]
  c <- data.frame(TukeyHSD(mod)[3])[5,4]
  d <- data.frame(TukeyHSD(mod)[3])[6,4]
  mdedvfded[i] <- a
  fhvfded[i] <- b
  mhvmded[i] <- c
  mhvfh[i] <- d
}



## Making each list a data frame so it can be easily manipulated
#MDED : FDED
mdedvfded_df <- data.frame(mdedvfded)
head(mdedvfded_df)

#FH : FDED
fhvfded_df <- data.frame(fhvfded)
head(fhvfded_df)

#MH : MDED
mhvmded_df <- data.frame(mhvmded)
head(mhvmded_df)

#MH : FH
mhvfh_df <- data.frame(mhvfh)
head(mhvfh_df)




## I gotta add the gene names back into each of these data frames, and delete the rownames, which become redundant. Also going to rename the column with p adj
genenames <- rnadata[,1]
head(genenames)

#MDED : FDED
mdedvfded_df <- cbind(genenames, mdedvfded_df)
rownames(mdedvfded_df) <- NULL
names(mdedvfded_df)[2] <- "p_adj"
head(mdedvfded_df)

#FH : FDED
fhvfded_df <- cbind(genenames, fhvfded_df)
rownames(fhvfded_df) <- NULL
names(fhvfded_df)[2] <- "p_adj"
head(fhvfded_df)

#MH : MDED
mhvmded_df <- cbind(genenames, mhvmded_df)
rownames(mhvmded_df) <- NULL
names(mhvmded_df)[2] <- "p_adj"
head(mhvmded_df)

#MH : FH
mhvfh_df <- cbind(genenames, mhvfh_df)
rownames(mhvfh_df) <- NULL
names(mhvfh_df)[2] <- "p_adj"
head(mhvfh_df)



## Now will arrange each dataframe by increasing p adj value (note that you need the dplyr package)
#MDED : FDED
mdedvfded_df_ordered <- arrange(mdedvfded_df, p_adj)
head(mdedvfded_df_ordered)
sum(mdedvfded_df_ordered[,2] < 0.05)

#FH : FDED
fhvfded_df_ordered <- arrange(fhvfded_df, p_adj)
head(fhvfded_df_ordered)
sum(fhvfded_df_ordered[,2] < 0.05)

#MH : MDED
mhvmded_df_ordered <- arrange(mhvmded_df, p_adj)
head(mhvmded_df_ordered)
sum(mhvmded_df_ordered[,2] < 0.05)

#MH : FH
mhvfh_df_ordered <- arrange(mhvfh_df, p_adj)
head(mhvfh_df_ordered)
sum(mhvfh_df_ordered[,2] < 0.05)




###########
### CONCLUSION
###########
##all significantly expressed genes
#MDED : FDED
sigp_mdedvfded <- head(mdedvfded_df_ordered, sum(mdedvfded_df_ordered[,2] < 0.05))
write.table(sigp_mdedvfded, file = "../results/Female DED vs Male DED/sigp_fdedvmded.csv", sep = ",")

#FH : FDED
sigp_fhvfded <- head(fhvfded_df_ordered, sum(fhvfded_df_ordered[,2] < 0.05))
write.table(sigp_fhvfded, file = "../results/Female Healthy vs Female DED/sigp_fhvfded.csv", sep = ",")

#MH : MDED
sigp_mhvmded <- head(mhvmded_df_ordered, sum(mhvmded_df_ordered[,2] < 0.05))
write.table(sigp_mhvmded, file = "../results/Male Healthy vs Male DED/sigp_mhvmded.csv", sep = ",")

#MH : FH
sigp_mhvfh <- head(mhvfh_df_ordered, sum(mhvfh_df_ordered[,2] < 0.05))
write.table(sigp_mhvfh, file = "../results/Female Healthy vs Male Healthy/sigp_fhvmh.csv", sep = ",")



##Heatmap (needs color brewer package)
mypalette <- brewer.pal(11,"RdYlBu")
morecols <- colorRampPalette(mypalette)
col.cell <- c(rep("purple",3),rep("orange",3))
head(rnadata)


  ###MDED : FDED
#Data Frame setup
rnadata_mdedvfded <- rnadata[,c(1,2,3,4,8,9,10)]
sigp_rnadata_mdedvfded <- rnadata_mdedvfded[sigp_mdedvfded[,1],]
rownames(sigp_rnadata_mdedvfded) <- sigp_rnadata_mdedvfded[,1]
sigp_rnadata_mdedvfded[,1] <- NULL

#heatmap plotting, make sure to export it!
heatmap.2(as.matrix(sigp_rnadata_mdedvfded[,1:6]), col=rev(morecols(50)), trace= "none", scale = "row",
          main = "DE Genes: FDED vs MDED", margins = c(6,6), cexRow = .5, Colv = NA, Rowv = NA)

heatmap.2(as.matrix(sigp_rnadata_mdedvfded[1:50,]), col=rev(morecols(50)), trace= "none", scale = "row",
          main = "Top 50 Genes: FDED vs MDED", margins = c(6,6), cexRow = .7, Colv = NA, Rowv = NA)

#Data Frame setup for significant genes heatmap, separated by expression/sex
sigp_rnadata_mdedvfded_diff <- rnadata_mdedvfded[sigp_mdedvfded[,1],]
head(sigp_rnadata_mdedvfded_diff)
tail(sigp_rnadata_mdedvfded_diff)
sigp_rnadata_mdedvfded_diff$fmeans <- rowMeans(sigp_rnadata_mdedvfded_diff[,2:4])
sigp_rnadata_mdedvfded_diff$mmeans <- rowMeans((sigp_rnadata_mdedvfded_diff[,5:7]))
sigp_rnadata_mdedvfded_diff$dif_f_m <- sigp_rnadata_mdedvfded_diff$fmeans - sigp_rnadata_mdedvfded_diff$mmeans
sigp_rnadata_mdedvfded_diff$total_avg <- (sigp_rnadata_mdedvfded_diff$fmeans + sigp_rnadata_mdedvfded_diff$mmeans)/2
sigp_rnadata_mdedvfded_diff$std_diff <- sigp_rnadata_mdedvfded_diff$dif_f_m / sigp_rnadata_mdedvfded_diff$total_avg

sigp_rnadata_mdedvfded_diff <- arrange(sigp_rnadata_mdedvfded_diff, std_diff)

rownames(sigp_rnadata_mdedvfded_diff) <- sigp_rnadata_mdedvfded_diff[,1]
sigp_rnadata_mdedvfded_diff[,1] <- NULL
head(sigp_rnadata_mdedvfded_diff)

#table for higher expression in females
write.csv(sigp_rnadata_mdedvfded_diff[nrow(sigp_rnadata_mdedvfded_diff):(length(which(sigp_rnadata_mdedvfded_diff$std_diff < 0))+1),], "../results/Female DED vs Male DED/fdedvmded_femaleexpression.csv")

#table for higher expression in males
write.csv(sigp_rnadata_mdedvfded_diff[which(sigp_rnadata_mdedvfded_diff$std_diff < 0),], "../results/Female DED vs Male DED/fdedvmded_maleexpression.csv")

#Plotting of heatmaps separated by expression/sex
#two heatmaps
#higher expression in females
heatmap.2(as.matrix(sigp_rnadata_mdedvfded_diff[nrow(sigp_rnadata_mdedvfded_diff):(length(which(sigp_rnadata_mdedvfded_diff$std_diff < 0))+1),1:6]
), col=rev(morecols(50)), trace= "none", scale = "row",
          main = "DE Genes: FDED vs MDED \nHigher Expression in Females", margins = c(6,6), cexRow = 0.9, Colv = NA, Rowv = NA)


#higher expression in males
heatmap.2(as.matrix(sigp_rnadata_mdedvfded_diff[which(sigp_rnadata_mdedvfded_diff$std_diff < 0),1:6]), col=rev(morecols(50)), trace= "none", scale = "row",
          main = "DE Genes: FDED vs MDED \n Higher Expression in Males", margins = c(6,6), cexRow = 1, Colv = NA, Rowv = NA)








  ###FH : FDED
#Data Frame setup for significant genes heatmap
rnadata_fhvfded <- rnadata[, c(1,5,6,7,2,3,4)]
sigp_rnadata_fhvfded <- rnadata_fhvfded[sigp_fhvfded[,1],]
rownames(sigp_rnadata_fhvfded) <- sigp_rnadata_fhvfded[,1]
sigp_rnadata_fhvfded[,1] <- NULL

#heatmap plotting of significant genes, make sure to export it!
heatmap.2(as.matrix(sigp_rnadata_fhvfded), col=rev(morecols(50)), trace= "none", scale = "row",
          main = "DE Genes: FH vs FDED", margins = c(6,6), cexRow = .5, Colv = NA, Rowv = NA)

heatmap.2(as.matrix(sigp_rnadata_fhvfded[1:50,]), col=rev(morecols(50)), trace= "none", scale = "row",
          main = "Top 50 Genes: FH vs FDED", margins = c(6,6), cexRow = .7, Colv = NA, Rowv = NA)

#Data Frame setup for significant genes heatmap, separated by expression/condition
sigp_rnadata_fhvfded_diff <- rnadata_fhvfded[sigp_fhvfded[,1],]
head(sigp_rnadata_fhvfded_diff)
tail(sigp_rnadata_fhvfded_diff)
sigp_rnadata_fhvfded_diff$hmeans <- rowMeans(sigp_rnadata_fhvfded_diff[,2:4])
sigp_rnadata_fhvfded_diff$dedmeans <- rowMeans((sigp_rnadata_fhvfded_diff[,5:7]))
sigp_rnadata_fhvfded_diff$dif_h_ded <- sigp_rnadata_fhvfded_diff$hmeans - sigp_rnadata_fhvfded_diff$dedmeans
sigp_rnadata_fhvfded_diff$total_avg <- (sigp_rnadata_fhvfded_diff$hmeans + sigp_rnadata_fhvfded_diff$dedmeans)/2
sigp_rnadata_fhvfded_diff$std_diff <- sigp_rnadata_fhvfded_diff$dif_h_ded / sigp_rnadata_fhvfded_diff$total_avg

sigp_rnadata_fhvfded_diff <- arrange(sigp_rnadata_fhvfded_diff, std_diff)

rownames(sigp_rnadata_fhvfded_diff) <- sigp_rnadata_fhvfded_diff[,1]
sigp_rnadata_fhvfded_diff[,1] <- NULL
head(sigp_rnadata_fhvfded_diff)

#table for higher expression in healthy
write.csv(sigp_rnadata_fhvfded_diff[nrow(sigp_rnadata_fhvfded_diff):(length(which(sigp_rnadata_fhvfded_diff$std_diff < 0))+1),], "../results/Female Healthy vs Female DED/fhvfded_healthyexpression.csv")

#table for higher expression in ded
write.csv(sigp_rnadata_fhvfded_diff[which(sigp_rnadata_fhvfded_diff$std_diff < 0),], "../results/Female Healthy vs Female DED/fhvfded_dedexpression.csv")

#Plotting of heatmaps separated by expression/sex
#two heatmaps
#higher expression in healthy
heatmap.2(as.matrix(sigp_rnadata_fhvfded_diff[nrow(sigp_rnadata_fhvfded_diff):(length(which(sigp_rnadata_fhvfded_diff$std_diff < 0))+1),1:6][1:50,]
), col=rev(morecols(50)), trace= "none", scale = "row",
main = "DE Genes: FH vs FDED \n Top 50 Expressed Genes in Healthy Females", margins = c(6,9), cexRow = 0.9, Colv = NA, Rowv = NA)


#higher expression in ded
heatmap.2(as.matrix(sigp_rnadata_fhvfded_diff[which(sigp_rnadata_fhvfded_diff$std_diff < 0),1:6][1:50,]), col=rev(morecols(50)), trace= "none", scale = "row",
          main = "DE Genes: FH vs FDED \n Top 50 Expressed Genes in DED Females", margins = c(6,9), cexRow = 0.9, Colv = NA, Rowv = NA)








  ###MH : MDED
#Data Frame setup for significant genes heatmap
rnadata_mhvmded <- rnadata[,c(1,11,12,13,8,9,10)]
sigp_rnadata_mhvmded <- rnadata_mhvmded[sigp_mhvmded[,1],]
rownames(sigp_rnadata_mhvmded) <- sigp_rnadata_mhvmded[,1]
sigp_rnadata_mhvmded[,1] <- NULL

#heatmap plotting of significant genes, make sure to export it!
heatmap.2(as.matrix(sigp_rnadata_mhvmded), col=rev(morecols(50)), trace= "none", scale = "row",
          main = "DE Genes: MH vs MDED", margins = c(6,6), cexRow = .5, Colv = NA, Rowv = NA )

heatmap.2(as.matrix(sigp_rnadata_mhvmded[1:50,]), col=rev(morecols(50)), trace= "none", scale = "row",
          main = "Top 50 Genes: MH vs MDED", margins = c(6,6), cexRow = .7, Colv = NA, Rowv = NA )

#Data Frame setup for significant genes heatmap, separated by expression/condition
sigp_rnadata_mhvmded_diff <- rnadata_mhvmded[sigp_mhvmded[,1],]
head(sigp_rnadata_mhvmded_diff)
tail(sigp_rnadata_mhvmded_diff)
sigp_rnadata_mhvmded_diff$hmeans <- rowMeans(sigp_rnadata_mhvmded_diff[,2:4])
sigp_rnadata_mhvmded_diff$dedmeans <- rowMeans((sigp_rnadata_mhvmded_diff[,5:7]))
sigp_rnadata_mhvmded_diff$dif_h_ded <- sigp_rnadata_mhvmded_diff$hmeans - sigp_rnadata_mhvmded_diff$dedmeans
sigp_rnadata_mhvmded_diff$total_avg <- (sigp_rnadata_mhvmded_diff$hmeans + sigp_rnadata_mhvmded_diff$dedmeans)/2
sigp_rnadata_mhvmded_diff$std_diff <- sigp_rnadata_mhvmded_diff$dif_h_ded / sigp_rnadata_mhvmded_diff$total_avg

sigp_rnadata_mhvmded_diff <- arrange(sigp_rnadata_mhvmded_diff, std_diff)

rownames(sigp_rnadata_mhvmded_diff) <- sigp_rnadata_mhvmded_diff[,1]
sigp_rnadata_mhvmded_diff[,1] <- NULL
head(sigp_rnadata_mhvmded_diff)

#table for higher expression in healthy
write.csv(sigp_rnadata_mhvmded_diff[nrow(sigp_rnadata_mhvmded_diff):(length(which(sigp_rnadata_mhvmded_diff$std_diff < 0))+1),], "../results/Male Healthy vs Male DED/mhvmded_healthyexpression.csv")

#table for higher expression in ded
write.csv(sigp_rnadata_mhvmded_diff[which(sigp_rnadata_mhvmded_diff$std_diff < 0),], "../results/Male Healthy vs Male DED/mhvmded_dedexpression.csv")

#Plotting of heatmaps separated by expression/sex
#two heatmaps
#higher expression in healthy
heatmap.2(as.matrix(sigp_rnadata_mhvmded_diff[nrow(sigp_rnadata_mhvmded_diff):(length(which(sigp_rnadata_mhvmded_diff$std_diff < 0))+1),1:6][1:50,]
), col=rev(morecols(50)), trace= "none", scale = "row",
main = "DE Genes: MH vs MDED \n Top 50 Expressed Genes in Healthy Males", margins = c(6,9), cexRow = 0.9, Colv = NA, Rowv = NA)


#higher expression in ded
heatmap.2(as.matrix(sigp_rnadata_mhvmded_diff[which(sigp_rnadata_mhvmded_diff$std_diff < 0),1:6][1:50,]), col=rev(morecols(50)), trace= "none", scale = "row",
          main = "DE Genes: MH vs MDED \n Top 50 Expressed Genes in DED Males", margins = c(6,9), cexRow = 0.9, Colv = NA, Rowv = NA)









  ###MH : FH
#Data Frame setup for significant genes heatmap
rnadata_mhvfh <- rnadata[,c(1,5,6,7,11,12,13)]
sigp_rnadata_mhvfh <- rnadata_mhvfh[sigp_mhvfh[,1],]
rownames(sigp_rnadata_mhvfh) <- sigp_rnadata_mhvfh[,1]
sigp_rnadata_mhvfh[,1] <- NULL

#heatmap plotting for significant genes, make sure to export it!
heatmap.2(as.matrix(sigp_rnadata_mhvfh), col=rev(morecols(50)), trace= "none", scale = "row",
          main = "DE Genes: FH vs MH", margins = c(6,6), cexRow = .5, Colv = NA, Rowv = NA )

heatmap.2(as.matrix(sigp_rnadata_mhvfh[1:50,]), col=rev(morecols(50)), trace= "none", scale = "row",
          main = "Top 50 Genes: FH vs MH", margins = c(6,6), cexRow = .7, Colv = NA, Rowv = NA )

#Data Frame setup for significant genes heatmap, separated by expression/sex
sigp_rnadata_mhvfh_diff <- rnadata_mhvfh[sigp_mhvfh[,1],]
head(sigp_rnadata_mhvfh_diff)
tail(sigp_rnadata_mhvfh_diff)
sigp_rnadata_mhvfh_diff$fmeans <- rowMeans(sigp_rnadata_mhvfh_diff[,2:4])
sigp_rnadata_mhvfh_diff$mmeans <- rowMeans((sigp_rnadata_mhvfh_diff[,5:7]))
sigp_rnadata_mhvfh_diff$dif_f_m <- sigp_rnadata_mhvfh_diff$fmeans - sigp_rnadata_mhvfh_diff$mmeans
sigp_rnadata_mhvfh_diff$total_avg <- (sigp_rnadata_mhvfh_diff$fmeans + sigp_rnadata_mhvfh_diff$mmeans)/2
sigp_rnadata_mhvfh_diff$std_diff <- sigp_rnadata_mhvfh_diff$dif_f_m / sigp_rnadata_mhvfh_diff$total_avg

sigp_rnadata_mhvfh_diff <- arrange(sigp_rnadata_mhvfh_diff, std_diff)

rownames(sigp_rnadata_mhvfh_diff) <- sigp_rnadata_mhvfh_diff[,1]
sigp_rnadata_mhvfh_diff[,1] <- NULL
head(sigp_rnadata_mhvfh_diff)

#table for higher expression in females
write.csv(sigp_rnadata_mhvfh_diff[nrow(sigp_rnadata_mhvfh_diff):(length(which(sigp_rnadata_mhvfh_diff$std_diff < 0))+1),], "../results/Female Healthy vs Male Healthy/fhvmh_femaleexpression.csv")

#table for higher expression in males
write.csv(sigp_rnadata_mhvfh_diff[which(sigp_rnadata_mhvfh_diff$std_diff < 0),], "../results/Female Healthy vs Male Healthy/fhvmh_maleexpression.csv")

#Plotting of heatmaps separated by expression/sex
#two heatmaps
#higher expression in females
heatmap.2(as.matrix(sigp_rnadata_mhvfh_diff[nrow(sigp_rnadata_mhvfh_diff):(length(which(sigp_rnadata_mhvfh_diff$std_diff < 0))+1),1:6]
), col=rev(morecols(50)), trace= "none", scale = "row",
main = "DE Genes: FH vs MH \nHigher Expression in Females", margins = c(6,9), cexRow = 0.8, Colv = NA, Rowv = NA)


#higher expression in males
heatmap.2(as.matrix(sigp_rnadata_mhvfh_diff[which(sigp_rnadata_mhvfh_diff$std_diff < 0),1:6]), col=rev(morecols(50)), trace= "none", scale = "row",
          main = "DE Genes: FH vs MH \n Higher Expression in Males", margins = c(6,6), cexRow = 1, Colv = NA, Rowv = NA)








